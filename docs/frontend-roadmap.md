# Дорожная карта фронтенда (высокоуровневый план)

Проект: онлайн‑библиотека с мультиязычностью (en, es, fr, pt), публичным сайтом и админкой. Фронт: Next.js (App Router) + TypeScript + Ant Design + React Query + Auth.js (NextAuth). Бэкенд — NestJS REST под /api.

Гайдлайны и константы:

- Публичные страницы под префиксом `/:lang` (en|es|fr|pt). Язык в пути имеет приоритет над `?lang` и `Accept-Language`.
- Админ: `(/admin)/:lang` + заголовок `X-Admin-Language`/`Accept-Language` для языка контента.
- SEO: canonical/hreflang, генерация метаданных через `/:lang/seo/resolve` (см. docs/frontend-agents/seo.md).
- Авторизация: NextAuth (Credentials), JWT + refresh по `/auth/refresh`.
- Данные: React Query, типы из OpenAPI `/api/docs-json`.

## Этапы (milestones)

M0 — Bootstrap проекта (скелет публичного и админ‑приложения)

- Создать Next.js (App Router, TS), Ant Design, React Query, NextAuth; ESLint/Prettier.
- Структура каталогов: `app/[lang]/…` для публичных страниц, `app/admin/[lang]/…` для админки.
- Конфиг `.env`: `NEXT_PUBLIC_API_BASE_URL`, базовые переменные NextAuth.
- Базовые layout’ы, темизация AntD, шапка/футер, ErrorBoundary/NotFound.
- Языковой контур: ограничение `lang` ∈ `en|es|fr|pt`, переключатели языка (публичный и админ).
- Acceptance: сборка без ошибок; маршруты-«заглушки» существуют; переключатель языка меняет URL.

M1 — Auth и роли (доступ в админку)

- NextAuth Credentials: login через `/auth/login`, jwt‑сессия, хранение `accessToken/refreshToken`.
- Авто‑рефреш в jwt callback через `/auth/refresh`.
- Фетч `/users/me` для ролей; защита маршрутов админки (admin|content_manager).
- Acceptance: вход/выход, защита admin‑маршрутов, корректный refresh токенов.

M2 — Слой данных и типы

- Генерация типов из OpenAPI (`/api/docs-json`) → `src/api/types.ts`.
- Базовый fetcher/клиент: базовый URL из env, `Authorization`, `Accept-Language`, разбор ошибок.
- React Query: ключи, политика retry, кэш с учётом `lang`.
- Acceptance: 2–3 демонстрационных запроса с корректными заголовками, обработка 401/404/429.

M3 — Админка MVP (мультиязычный контент)

- Роутинг: `app/admin/[lang]/…`, UI‑переключатель языка админки.
- Сущности (минимально):
  - Pages (CMS): список, создание/редактирование переводов (по `lang`), slug, SEO‑поля, публикация.
  - Books: базовые поля, связка переводов по языку.
  - Versions (text/audio) + главы: минимальные формы, связь с книгой, поля языка.
  - Taxonomy: категории/теги (локализуемые), привязка к книгам/версиям.
  - SEO: поля на уровне страницы/книги, предпросмотр метатегов.
- Валидация форм, понятные ошибки бэкенда, optimistic UI где уместно.
- Acceptance: можно создать/отредактировать/опубликовать контент для 2–4 языков; элементы отображают статус наличия переводов.

M4 — Наполнение тестовыми данными

- Через админку создать: 5–10 страниц CMS, 10–20 книг (часть с версиями/главами), категории/теги — с переводами.
- Acceptance: есть демонстрационный набор контента на всех 4 языках.

M5 — Публичный сайт MVP (каталог + страницы)

- Страницы: `/:lang/pages/[slug]`, `/:lang/books/[slug]/overview`, `/:lang/categories/[slug]/books`, `/:lang/tags/[slug]/books`.
- SSR/SSG где уместно; `notFound()` для 404; переключатель языка с учётом `availableLanguages`.
- SEO: `generateMetadata()` через `/:lang/seo/resolve`, canonical/hreflang.
- Acceptance: публичные страницы читают реальный контент, корректная навигация и метаданные.

M6 — Читалка/плеер версий (neutral routes)

- Маршрут: `/(neutral)/versions/[id]` (без префикса `:lang`).
- Данные: детали версии, список глав (текст/аудио), краткое описание/summary.
- Базовые интеракции: полка (bookshelf), прогресс чтения, лайки/комменты (минимум).
- Acceptance: можно открыть версию, листать главы, сохраняется прогресс; базовые социальные действия работают.

M7 — SEO и индексация

- Хрефланги на всех публичных страницах, x‑default.
- Sitemap per‑language или опора на backend‑sitemap; robots.
- Микроразметка там, где уместно (книги/статьи) — опционально.
- Acceptance: валидные теги, корректные canonical/hreflang; генерация/отдача sitemap.

M8 — Производительность и UX‑полировка

- Ленивая загрузка, оптимизация изображений, кеширование/`revalidate`.
- Адаптив, доступность (a11y), клавиатурная навигация.
- Системные страницы ошибок, дружелюбные сообщения для 429/500.
- Acceptance: базовые метрики в норме, нет блокирующих UX‑проблем.

M9 — Тесты и качество

- Unit (Vitest/Jest), компонентные (Testing Library), e2e (Playwright).
- Линтеры, pre‑commit hooks, минимальные контурные тесты для критичных фич (auth, i18n, SEO, читалка).
- Acceptance: CI проходит, ключевые e2e зелёные.

M10 — CI/CD и деплой

- Dockerfile фронта, окружения для dev/stage/prod.
- Настройка сборки и деплоя (Vercel/компоновка с VPS), переменные окружения.
- Мониторинг (логи/ошибки) и алерты — опционально.
- Acceptance: повторяемый деплой, переменные настроены, smoke‑тест после релиза.

## Зависимости и порядок

1. M0 → M1 → M2 — базовая платформа.
2. M3 → M4 — админка и наполнение.
3. M5 → M6 → M7 — публичный сайт и читалка, SEO.
4. M8–M10 — качество, перф, деплой.

## Критические моменты i18n

- Всегда включать `Accept-Language: <lang>` и/или `:lang` в пути (см. docs/frontend-agents/architecture-and-routing.md).
- В админке язык контента выбирается UI‑переключателем; явно передавать язык при запросах.
- Переключатель языка должен учитывать доступные переводы (`availableLanguages`) и корректно маппить слуги.

## Проверка качества (быстрые гейты)

- Build: Next.js билд без ошибок.
- Lint/Typecheck: ESLint/TS проходят.
- Unit/e2e: минимальный набор зелёный.
- Smoke: открыть 3–5 ключевых маршрутов (admin/public/reader) и проверить контент/SEO.

## Следующие шаги (для детализации ТЗ)

- Итерация A: детальный ТЗ на M0–M2 (bootstrap, auth, данные, i18n):
  - Структура `app/` + шаблоны layout/page, провайдеры, theming.
  - Конфиг NextAuth (callbacks, refresh), guarded routes.
  - API‑клиент, перехватчики 401/refresh, ключи React Query, маппинг ошибок.
  - Компоненты переключателя языка (public/admin) и политика резолва URL при смене языка.
- Итерация B: детальный ТЗ на M3 (админка MVP):
  - Схемы форм (Zod/Yup), CRUD‑флоу, индикаторы переводов, предпросмотр SEO, статусы публикации.
  - Навигация/поиск в админке, роли/права.
- Итерация C: детальный ТЗ на M5–M6 (публичные страницы + читалка):
  - Контракты данных (см. docs/frontend-agents/pages-contracts.md), SEO‑метаданные, hreflang.
  - Читалка/плеер, прогресс, полка, комментарии/лайки (минимум).

## Админка: как реализуем мультиязычность

Подход — «как в WordPress»: отдельный контент‑контекст на каждый язык с явным переключателем. Текущий язык задаётся сегментом в URL и влияет на список, формы и отправляемые заголовки.

1. URL‑пространство и контекст языка

- Маршруты админки: `/admin/[lang]/…`, где `lang ∈ en|es|fr|pt`.
- В `app/admin/[lang]/layout.tsx` создаём `AdminLanguageProvider` и шапку с переключателем языка.
- Переключатель меняет только сегмент `[lang]` и, если открыта сущность, пытается открыть её перевод на целевом языке (или открыть форму создания перевода).

2. Модель контента (FE‑уровень)

- Каждая «логическая» сущность (Book, Page, Category/Tag) имеет:
  - `groupId` (общий для всех переводов, выдаётся backend) — ключ для маппинга между языками.
  - Локализованные записи по одному на язык: `{ id, lang, title, slug, seo, … }`.
  - Нейтральные поля (или связи), общие для переводов: например, связь книги с версиями.
- Slug и SEO — строго per‑language. Уникальность slug — в рамках языка.

3. API и заголовки

- Все admin‑запросы отправляем с `Accept-Language: [lang]` (или `X-Admin-Language: [lang]`, если backend поддерживает — у нас этот заголовок имеет приоритет).
- Списки: фильтруем по текущему языку, backend возвращает также `availableLanguages`/матрицу переводов.
- Резолв перевода: по `groupId` + `targetLang` (эндпоинт вида `/…/translations?groupId=&lang=`). Если отсутствует — FE открывает форму создания перевода и может предложить копирование полей из исходного языка.

4. UX‑паттерны админки

- Списки: по умолчанию показываем элементы только текущего языка; у каждого элемента бейдж‑матрица языков (en/es/fr/pt) с быстрыми ссылками «создать перевод»/«редактировать перевод».
- Формы: создаём/редактируем запись конкретного языка. Кнопка «Создать перевод на …» доступна из карточки/формы; открывает форму нового перевода, предварительно заполняя поля из выбранного исходного языка.
- Статусы: «черновик/опубликовано», «есть/нет перевода» — визуально заметны.
- Переключение языка на странице редактирования:
  - Если перевод на целевой язык существует → редирект на его `id`.
  - Если нет → предложение «создать перевод», с передачей `groupId` и возможностью копирования.
- Защита от потери данных: при наличии несохранённых изменений — confirm‑диалог перед переключением языка/роутом.

5. Публичный сайт и соответствие

- Переключатель языка в публичной шапке меняет `/:lang` и пытается открыть ту же сущность на целевом языке (по `groupId`); при отсутствии перевода — 404 (для CMS страниц) или страница‑заглушка с ссылками на доступные языки (по политикам из docs).
- SEO: админка управляет пер‑языковыми SEO‑полями; публичка использует `/:lang/seo/resolve` и строит hreflang‑кластер.

6. Технические компоненты (FE)

- `useAdminLang()` — текущий язык, хелперы для заголовков/клиента.
- `AdminLanguageSwitcher` — универсальный переключатель, знающий как резолвить перевод для текущего роут‑типа.
- `resolveTranslationRoute(entity, currentLang, targetLang)` — утилита, которая:
  1. по `groupId` + `targetLang` находит `targetId`,
  2. возвращает маршрут для редактирования перевода, либо маршрут создания перевода с `groupId` и `sourceLang`.
- API‑клиент с автоматической подстановкой `Accept-Language`/`X-Admin-Language` и обработкой 401→refresh.

7. Валидация и ошибки

- 409 (конфликт slug) — валидация slug per‑language.
- 404 (нет перевода) — нормальный кейс для быстрого создания перевода.
- 401/403 — редирект на логин или сообщение о правах (только admin|content_manager).
- 429 — дружественный месседж (для массовых операций/загрузок).

8. Доп. удобства (необязательно на MVP)

- Режим «All languages» в списках (матрица переводов таблицей).
- Массовое создание «пустых переводов» под выбранные языки.
- Автогенерация slug из названия с учётом языка (транслитерация).

Итог: модель «отдельная админка на язык» через `/admin/[lang]` — принимаем. Добавляем резолвер переводов по `groupId`, единые переключатели языка и UX для быстрого создания/редактирования переводов. Это даёт предсказуемое поведение для контент‑менеджеров и упрощает маппинг с публичным сайтом.
