# M8 — Производительность и UX‑полировка — подробное ТЗ

Цель: улучшить скорость загрузки, отзывчивость и качество интерфейса на всех ключевых маршрутах. Сфокусироваться на LCP/CLS/INP, экономии бандла, кэшировании, ленивой загрузке и доступности. Довести UX‑детали: состояния загрузки/ошибок, адаптив, клавиатурная навигация.

Зависимости: M0–M7 (весь основной функционал готов и индексируется).

## Результат этапа

- Бюджеты производительности достигнуты (Lighthouse/CrUX): LCP ≤ 2.5s, CLS ≤ 0.1, INP ≤ 200ms на выборке целевых страниц.
- Снижен размер критического JS/SSR‑overhead; настроено кэширование и оптимизация изображений/шрифтов.
- UI отзывчив и доступен: корректные skeleton/empty/error состояния, клавиатурная навигация, базовая a11y пройдена.

---

## Общие принципы

- «Сначала SSR данные, затем минимальный интерактив»: больше серверных компонентов, меньше клиентского JS.
- Разделять бандл: динамические импорты, tree‑shaking, избегать тяжёлых зависимостей в общем layout.
- Кэшировать всё, что можно: ISR/`revalidate`, CDN, long‑term cache для статики, разумные `Cache-Control`.
- UX: мгновенная обратная связь (skeleton/spinner), предсказуемая навигация, безопасные ошибки.

---

## Задачи и ТЗ

### 1) Измерения и бюджеты

ТЗ:

- Добавить Lighthouse‑профили для ключевых страниц: `/:lang`, `/:lang/pages/[slug]`, `/:lang/books/[slug]/overview`, таксономии, `/versions/[id]`.
- Зафиксировать бюджеты (LCP/CLS/INP/TTFB/Total JS) в `docs/perf/budgets.md`.
- Включить Web Vitals сбор (client): INP/LCP/CLS → `console` или интеграция с аналитикой (опц.).
  Критерии приёмки:
- Есть базовый отчёт, целевые бюджеты согласованы.
  Артефакты:
- `docs/perf/budgets.md`, `src/lib/vitals.ts` (репортинг).

### 2) Бандл и клиентский JS

ТЗ:

- Включить анализ бандла (плагин/эксперимент Next). Разрезать крупные клиентские компоненты динамическими импортами `next/dynamic` с `ssr: false` там, где уместно (плеер, тяжёлые таблицы админки).
- Убедиться, что глобальные провайдеры/layout — серверные где возможно; вынести клиентские провайдеры из корневого layout в более низкий уровень.
- Удалить неиспользуемые библиотеки; убедиться, что AntD подключается «точечно» (tree‑shake‑friendly импорты).
  Критерии приёмки:
- Снижение Total JS по Lighthouse; отсутствие крупных дубликатов в бандле.
  Артефакты:
- `next.config.js` (включение анализа) и правки импортов/динамики.

### 3) Изображения и шрифты

ТЗ:

- Везде использовать `next/image` для обложек/превью (размеры, приоритет для LCP‑изображения, формат AVIF/WebP).
- Настроить `<link rel="preload">` для критического шрифта; подключить system‑stack или variable font; `font-display: swap`.
- Проверить отсутствие layout shift: фиксированные контейнеры с шириной/высотой.
  Критерии приёмки:
- Снижен LCP/CLS; картинки не вызывают скачков.
  Артефакты:
- Правки компонентов карточек/обложек, `app/[lang]/layout.tsx` (preload).

### 4) Кэширование и ISR

ТЗ:

- Проставить `revalidate` на публичных страницах (каталоги/страницы) от 300–600s. Нейтральные `/versions/:id` — `no-store` или короткий `revalidate` по смыслу.
- Для SEO‑resolve — кэшировать 600s, не дублировать запросы.
- Настроить заголовки `Cache-Control` для статики/изображений (долгий max‑age + immutable).
  Критерии приёмки:
- Перезагрузки быстрые; данные обновляются периодически без ручного вмешательства.
  Артефакты:
- Правки страниц/утилит fetch, конфиг сервинга статики.

### 5) Prefetch/Prerender

ТЗ:

- Включить `prefetch` для ссылок на соседние страницы/глубокой навигации (Next `<Link>` prefetch).
- Для карточек каталога — пререндер соседних/book overview по наведению (опц.).
  Критерии приёмки:
- Навигация ощущается мгновенной; нет лишних запросов.
  Артефакты:
- Обновления ссылок и навигационных компонентов.

### 6) Реакция UI: загрузка/ошибки/empty

ТЗ:

- Единые skeleton/placeholder компоненты для списков, карточек, страниц деталей.
- Глобальная шина ошибок: отображение тостов/баннеров для 409/429/5xx; кнопка «Повторить» для GET.
- Empty‑состояния с понятными CTA (навигация назад/к разделам).
  Критерии приёмки:
- Визуал консистентен; пользователь всегда понимает, что происходит.
  Артефакты:
- `src/components/ui/Skeletons/*`, `src/components/ui/EmptyState.tsx`, тосты.

### 7) Адаптив и интерактивность

ТЗ:

- Проверить брейкпоинты (мобайл/планшет/десктоп), размеры кликабельных элементов.
- Жесты/scroll‑поведение в читалке/плеере; sticky‑toolbar на мобильных.
- Минимизировать layout thrashing: использовать CSS трансформации вместо reflow, `will-change` осторожно.
  Критерии приёмки:
- Удобно пользоваться на мобильных; нет заметных лагов при скролле.
  Артефакты:
- CSS/компонентные правки.

### 8) A11y и клавиатурная навигация

ТЗ:

- «Skip to content» ссылка, правильные заголовки уровней, ролы/ARIA для основных компонентов.
- Фокус‑стили (не убирать), циклический фокус в модалках, доступные контролы плеера.
- Контраст — минимум AA.
  Критерии приёмки:
- Базовый Lighthouse a11y ≥ 90; ручная проверка клавиатурой проходит.
  Артефакты:
- `src/components/a11y/*`, правки существующих компонентов.

### 9) Оптимизация React Query

ТЗ:

- Настроить агрессивные `staleTime`/`cacheTime` там, где данные редко меняются; отключить `refetchOnWindowFocus` для тяжёлых запросов.
- Бэтчинг запросов, ключи с языком, запрет повторов при 4xx; background refresh по таймеру только для часто меняющихся.
  Критерии приёмки:
- Меньше сетевых запросов; стабильные состояния без лишней перезагрузки.
  Артефакты:
- Правки `queryClient` и отдельных хуков.

### 10) Скрипты и сторонние ресурсы

ТЗ:

- Откладывать/лениво грузить сторонние скрипты (аналитика/реклама), использовать `next/script` с `strategy="afterInteractive"|"lazyOnload"`.
- Минимизировать влияние рекламных блоков: резервация места для предотвращения CLS.
  Критерии приёмки:
- CLS не растёт из‑за сторонних виджетов; First Input не ухудшается значительно.
  Артефакты:
- Вставки скриптов, контейнеры с фиксированными размерами.

### 11) Логи, мониторинг и алерты (опц.)

ТЗ:

- Интегрировать сбор ошибок (Sentry или аналог) и Web Vitals отчёт к бэкенду/аналитике.
- Настроить минимальные алерты (рост ошибок, падение vitals).
  Критерии приёмки:
- Ошибки и метрики видны в панели; критические события не теряются.
  Артефакты:
- `src/lib/monitoring.ts`, подключение в layout.

### 12) Тестирование и регрессии

ТЗ:

- Lighthouse‑скрипты (локально) для ключевых страниц; сравнение с бюджетами.
- E2E smoke под нагрузкой (мобильная сеть/эмуляция), проверка skeleton/ошибок.
- Визуальные снапшоты критических страниц (опц.).
  Критерии приёмки:
- Целевые бюджеты достигнуты; UX остаётся стабильным.
  Артефакты:
- `docs/perf/report.md`, конфиги тестов.

---

## Схема директорий (релевантное для M8)

```
next.config.js               # анализ бандла, оптимизации
app/[lang]/layout.tsx        # preload шрифтов/картинок, skip‑links
src/lib/
  vitals.ts                  # web vitals report
  monitoring.ts              # Sentry/аналитика (опц.)
  seo.ts                     # доработки кэша/canonical если потребуется
  queryClient.ts             # тюнинг опций
src/components/ui/
  Skeletons/*
  EmptyState.tsx
  SkipLink.tsx
src/components/a11y/*
```

## Каркасы (скелеты)

### `src/lib/vitals.ts`

```ts
export function reportWebVitals(metric: any) {
  // metric: { id, name, label, value, delta }
  // Отправить в аналитику или лог
  if (typeof window !== 'undefined') {
    // eslint-disable-next-line no-console
    console.log('[vitals]', metric.name, Math.round(metric.value))
  }
}
```

### Пример подключения Web Vitals

```ts
// app/layout.tsx (или client entry)
export { reportWebVitals } from '@/src/lib/vitals'
```

### `next.config.js` (фрагмент)

```js
/** @type {import('next').NextConfig} */
const nextConfig = {
  reactStrictMode: true,
  // experimental: { optimizePackageImports: ['antd'] }, // опц. при поддержке
  images: { formats: ['image/avif', 'image/webp'] },
}
module.exports = nextConfig
```

---

## Риски и примечания

- Чрезмерная клиентская динамика может ухудшить INP: балансировать SSR и интерактив.
- Реклама/сторонние виджеты — главный источник CLS/INP: резервирование места и отложенная загрузка обязательны.
- Убедиться, что оптимизации не ломают i18n/SEO (canonical/hreflang стабильны).

## Чек‑лист готовности M8

- [ ] Budgets определены и достигнуты (LCP/CLS/INP)
- [ ] Снижен клиентский JS и оптимизированы импорты
- [ ] Оптимизация изображений/шрифтов, без layout shifts
- [ ] Кэширование/ISR настроены, быстрые повторные заходы
- [ ] Prefetch/Prerender на ключевых путях
- [ ] Единые skeleton/empty/error состояния
- [ ] Адаптив и a11y на уровне ≥ AA / Lighthouse a11y ≥ 90
- [ ] Оптимизация React Query и сторонних скриптов
- [ ] Логи/мониторинг подключены (опц.)
- [ ] Отчёты Lighthouse приложены и проходят бюджеты
