# M5 — Публичный сайт MVP (каталог + страницы) — подробное ТЗ

Цель: реализовать основные публичные страницы под префиксом `/:lang` (en|es|fr|pt) с SSR/SSG, корректной i18n‑навигацией, SEO‑метаданными, списками по таксономиям и картой обзора книги.

Зависимости: M0–M4 (каркас, auth слой, HTTP/типы, админка, наполненный контент).

## Результат этапа

- Работают маршруты:
  - `/:lang/pages/[slug]` — CMS страница.
  - `/:lang/books/[slug]/overview` — обзор книги.
  - `/:lang/categories/[slug]/books` — список книг по категории.
  - `/:lang/tags/[slug]/books` — список книг по тегу.
- SEO: `generateMetadata()` со `/:lang/seo/resolve`, корректные canonical и hreflang; базовый sitemap (опц.).
- Переключатель языка учитывает доступные переводы и корректно резолвит URL.
- Ошибки: 404 → `notFound()`, 500 → error boundary; пагинация, базовый поиск/фильтры.

---

## Общие принципы

- Язык: `:lang` в пути — доминирует; дополнительно `Accept-Language: <lang>` в запросах (см. docs/frontend-agents/architecture-and-routing.md).
- Данные: серверные компоненты для первичного SSR/SSG; клиентские субкомпоненты — для интерактивных частей.
- SEO: использовать `/:lang/seo/resolve?type=book|version|page&id=...` (см. docs/frontend-agents/seo.md), строить hreflang‑кластер (en|es|fr|pt|x-default).
- Слоги/переводы: при переключении языка стараться открывать ту же сущность (по groupId/availableLanguages). Если перевода нет — 404 или мягкая заглушка со ссылками.

---

## Задачи и ТЗ

### 1) Базовый layout и общий хедер/футер

ТЗ:

- `app/[lang]/layout.tsx`: общий каркас публички (шапка, навигация, футер), провайдеры из M0/M2, извлечение `lang` из `params`.
- В шапке: глобальный `LanguageSwitcher` (знает текущий путь и пытается резолвить перевод, см. задачу 5).
  Критерии приёмки:
- Общие части рендерятся на всех страницах, переключение языка не ломает навигацию.
  Артефакты:
- `app/[lang]/layout.tsx`, `src/components/LanguageSwitcher.tsx` (доработка).

### 2) CMS страница: `/:lang/pages/[slug]`

ТЗ:

- Серверный компонент `page.tsx`:
  - GET `/:lang/pages/:slug`.
  - 404 → `notFound()`.
  - `generateMetadata()` → GET `/:lang/seo/resolve?type=page&id=:slug` (или опираться на данные страницы, если backend уже возвращает SEO в теле).
- Рендер контента: пока простой вывод `title` и `content` (позже подключим rich‑text/MDX).
  Критерии приёмки:
- Страница открывается для существующих slug; 404 на несуществующие; метаданные отрабатывают.
  Артефакты:
- `app/[lang]/pages/[slug]/page.tsx`, `app/[lang]/pages/[slug]/generateMetadata.ts` (опц.).

### 3) Обзор книги: `/:lang/books/[slug]/overview`

ТЗ:

- Серверный компонент `page.tsx`:
  - GET `/:lang/books/:slug/overview` (см. docs/frontend-agents/pages-contracts.md).
  - Показать: название, автора (если есть), обложку (опц.), CTA к чтению/прослушиванию (ссылки на `/(neutral)/versions/[id]` из `versionIds`).
  - Переключение языка: список доступных языков (`availableLanguages`).
  - `generateMetadata()` → `/:lang/seo/resolve?type=book&id=:slug` или `overview.seo`.
    Критерии приёмки:
- На контенте из M4 страница показывает данные; CTA ведут к корректным маршрутам (без языка).
  Артефакты:
- `app/[lang]/books/[slug]/overview/page.tsx` (+ metadata).

### 4) Списки по таксономиям

ТЗ:

- Категории: `/:lang/categories/[slug]/books` → GET `/:lang/categories/:slug/books` (поддержать `page`, `limit` — если есть).
- Теги: `/:lang/tags/[slug]/books` → GET `/:lang/tags/:slug/books`.
- Рендер: карточки версий/книг (минимум: название, язык/тип, кнопка к обзору/версии), пагинация, состояние пустоты.
- `generateMetadata()` → `/:lang/seo/resolve?type=page&id=taxonomy:<slug>` (или бэкендовый контракт для таксономий).
  Критерии приёмки:
- Для выбранных категорий/тегов видны непустые списки, пагинация работает.
  Артефакты:
- `app/[lang]/categories/[slug]/books/page.tsx`, `app/[lang]/tags/[slug]/books/page.tsx`, `src/components/catalog/VersionCard.tsx` (или BookCard).

### 5) Переключатель языка и резолв URL

ТЗ:

- `LanguageSwitcher`:
  - На страницах сущности (page/book/taxonomy) пытается резолвить slug на целевом языке.
  - Источники правды: поля ответа (например, `availableLanguages`), отдельный эндпоинт переводов по `groupId`, либо предзагруженная карта переводов (если будет предоставлена backend).
  - Если перевода нет — вести на заглушку или показать подсказку «Нет перевода на выбранный язык».
- Утилиты: `mapCurrentToLang(currentRoute, targetLang): { href, exists }`.
  Критерии приёмки:
- Переключение языка срабатывает корректно для существующих переводов; корректно обрабатывает отсутствие перевода.
  Артефакты:
- `src/utils/public-i18n.ts`, доработка `LanguageSwitcher`.

### 6) SEO: generateMetadata, hreflang и canonical

ТЗ:

- В каждом маршруте реализовать `generateMetadata()` с вызовом `/:lang/seo/resolve`.
- Hreflang: построить набор ссылок для всех доступных языков + `x-default`, учитывая канонические правила (см. docs/frontend-agents/seo.md).
- Canonical: для book/page включать `/:lang` префикс; для версий (в M6) — без префикса.
  Критерии приёмки:
- В DevTools/HTML видны корректные meta/og/tw и `<link rel="alternate" hreflang>`, `<link rel="canonical">`.
  Артефакты:
- Реализация `generateMetadata()` в соответствующих маршрутах, `src/lib/seo.ts` (утилиты).

### 7) Пагинация, параметры и стабильные ссылки

ТЗ:

- Для списков поддержать query‑параметры `page`, `limit`, возможно `q` для поиска; валидировать и нормализовать значения.
- Генерация стабильных ссылок: утилита `buildListUrl(base, { page, limit, q })`.
  Критерии приёмки:
- Изменение параметров отражается в URL; ссылки корректно восстанавливают состояние.
  Артефакты:
- `src/utils/url.ts` (или расширить существующий `url-state.ts`).

### 8) SSG/ISR и кэширование

ТЗ:

- Для CMS страниц и каталогов настроить `revalidate` (например, 300–600s). Индивидуальные страницы — `force-cache`/`revalidate` по смыслу.
- Учитывать язык в ключах кэша Next.js/React Query.
- Не кешировать персонализированные/авторизованные части (их почти нет на публичке M5).
  Критерии приёмки:
- Повторные заходы на страницы работают быстро, данные обновляются по таймеру revalidate.
  Артефакты:
- Использование `export const revalidate = ...` и параметров `fetch` в страницах.

### 9) Ошибки и состояния

ТЗ:

- 404 → `notFound()`; пустые списки → пустое состояние (с текстом и ссылками на другие разделы).
- Ошибки сети/500 → error boundary страницы/сегмента; кнопка «Повторить» (клиентская часть через React Query где уместно).
  Критерии приёмки:
- Предсказуемые состояния UI при отсутствии данных/ошибках.
  Артефакты:
- Сегментные `error.tsx`/`not-found.tsx`.

### 10) UI‑компоненты каталога

ТЗ:

- Базовые карточки книг/версий, гриды, пагинация (AntD Pagination), брэдкрамбы (если есть хлебные крошки из SEO resolve), скелетоны загрузки.
  Критерии приёмки:
- UI аккуратен, консистентен с темой; скелетоны показываются при загрузке клиентских частей.
  Артефакты:
- `src/components/catalog/*`.

### 11) Тестирование

ТЗ:

- E2E: открыть каждую из 4 страниц маршрутов; проверить 404; переключение языка; наличие canonical/hreflang; пагинацию.
- Unit: утилиты `public-i18n.ts`, `seo.ts`, `url.ts`.
  Критерии приёмки:
- Ключевые e2e зелёные; unit‑тесты утилит проходят.

---

## Схема директорий (релевантное для M5)

```
app/[lang]/
  layout.tsx
  pages/[slug]/page.tsx
  books/[slug]/overview/page.tsx
  categories/[slug]/books/page.tsx
  tags/[slug]/books/page.tsx

src/components/
  LanguageSwitcher.tsx
  catalog/
    VersionCard.tsx
    BookCard.tsx (опц.)

src/lib/
  seo.ts

src/utils/
  public-i18n.ts
  url.ts
```

## Риски и примечания

- Отсутствие перевода: корректно обрабатывать — 404 или мягкая заглушка с доступными языками; не ломать hreflang‑кластер.
- Слоги: взаимное соответствие slug между языками может требовать доп. эндпоинтов; обернуть логику в `public-i18n.ts` для дальнейшей доработки.
- SEO: следовать правилам canonical; не дублировать контент разных языков под одним canonical.
- Перфоманс: осторожно с клиентскими запросами поверх SSR — избегать дублирующих фетчей.

## Чек‑лист готовности M5

- [ ] CMS страница `/:lang/pages/[slug]` с SEO и 404
- [ ] Обзор книги `/:lang/books/[slug]/overview` с CTA к версиям
- [ ] Категории и теги: списки с пагинацией
- [ ] Переключатель языка резолвит переводы или корректно сообщает об их отсутствии
- [ ] SEO: generateMetadata + canonical + hreflang на всех страницах
- [ ] SSG/ISR настроены, кэш работает
- [ ] Ошибки/пустые состояния реализованы
- [ ] E2E + unit‑тесты утилит зелёные
