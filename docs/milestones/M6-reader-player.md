# M6 — Читалка/плеер версий (neutral routes) — подробное ТЗ

Цель: реализовать нейтральные (без префикса языка) маршруты чтения/прослушивания версий книги с прогрессом, полкой, лайками и комментариями. Поддержать текстовые и аудио‑версии, резюмировать разделы/summary.

Зависимости: M0–M5 (каркас, auth, слой данных и типы, админка и контент, публичка/SEO).

## Результат этапа

- Работает маршрут `/(neutral)/versions/[id]` с вкладками/вьюшками: чтение, прослушивание (если аудио), summary (если есть).
- Текстовая читалка: список глав, навигация «пред/след», сохранение прогресса (глава/позиция), возврат к последнему месту.
- Аудиоплеер: плейлист аудиоглав, отображение прогресса, продолжение с последней позиции.
- Кнопка «На полку» (bookshelf) — добавление/удаление с оптимистичным UI.
- Комментарии и лайки: список, добавление, лайк комментария/версии (минимум).
- SEO: canonical без `/:lang` (только `/versions/:id`), метаданные через `GET /seo/resolve?type=version&id=:id`.

---

## Общие принципы

- Роутинг: нейтральный, без `:lang` в пути; UI строки локализуемы по текущей UI‑локали (из публичной зоны), но контент языка — по версии (фиксированный).
- Данные: серверные компоненты для initial fetch версии; клиентские компоненты для интерактивных частей (читалка/плеер/комменты/лайки).
- Авторизация: чтение публичных версий — без auth; интеракции (полка/прогресс/комменты/лайки) — с auth. Неавторизованным — CTA «Войти» с callback обратно в `/versions/:id`.
- Язык заголовков: для нейтральных эндпоинтов можно передавать `Accept-Language` для сообщений/ошибок.

Контракты API (из docs/frontend-agents/api-cheatsheet.md):

- GET `/versions/:id` → детали версии.
- GET `/versions/:id/chapters` или `/versions/:id/audio-chapters` (page, limit) → списки.
- GET `/versions/:id/summary` → данные summary.
- GET `/comments?target=version|chapter|audio&targetId=...&page&limit`
- POST `/comments` → { text, bookVersionId|chapterId|audioChapterId, parentId? }
- PATCH `/likes/toggle` → { commentId? | bookVersionId? } → { liked, count }
- GET `/me/bookshelf`, POST `/me/bookshelf/:versionId`, DELETE `/me/bookshelf/:versionId`
- GET `/me/progress/:versionId`, PUT `/me/progress/:versionId` → { chapterNumber?|audioChapterNumber?, position }
- GET `/seo/resolve?type=version&id=:id` (canonical — без языка)

---

## Задачи и ТЗ

### 1) Роутинг и начальная страница версии

ТЗ:

- Маршрут: `app/(neutral)/versions/[id]/page.tsx` (серверный компонент).
- Данные: `GET /versions/:id` (cache: 'no-store' или revalidate малый).
- Рендер: заголовок версии (язык, тип text|audio), CTA к вкладкам/вьюшкам: «Читать», «Слушать» (если есть аудио), «Summary» (если есть).
- `generateMetadata()`: вызвать `GET /seo/resolve?type=version&id=:id`, выставить canonical `/versions/:id` и hreflang (x-default на тот же URL).
  Критерии приёмки:
- Страница версии открывается по id; SEO теги на месте; доступны нужные вкладки.
  Артефакты:
- `app/(neutral)/versions/[id]/page.tsx`, (опц.) `generateMetadata`.

### 2) Текстовая читалка (ReadingView)

ТЗ:

- Компоненты: `TextReader`, `ChapterList`, `ReaderToolbar`, `ProgressBar`.
- Потоки данных:
  - Список глав: `GET /versions/:id/chapters?page=&limit=` (навигация по страницам списка или загружать все — если API/объём позволяют). Минимум — загрузка текущей и соседних.
  - Детали главы (если есть отдельный эндпоинт `/chapters/:id`) — подгружать на открытие.
- Навигация: «Предыдущая/Следующая глава», быстрый выбор по списку.
- Прогресс: сохранять `chapterNumber` и `position` (смещение прокрутки/якорь) через `PUT /me/progress/:versionId` периодически (например, при смене главы и раз в N секунд). На входе версии — пробовать `GET /me/progress/:versionId` и восстанавливать.
- Состояния: пустые главы, конец/начало; ошибки — дружелюбные сообщения.
  Критерии приёмки:
- Можно читать главы последовательно, перезагрузка возвращает к последнему месту.
  Артефакты:
- `src/components/reader/TextReader.tsx`, `ChapterList.tsx`, `ReaderToolbar.tsx`, `ProgressBar.tsx`.

### 3) Аудиоплеер (ListeningView)

ТЗ:

- Компоненты: `AudioPlayer`, `AudioPlaylist`, `PlayerControls`.
- Потоки данных: `GET /versions/:id/audio-chapters?page&limit` (или загрузка всех при малом объёме).
- Проигрывание: HTMLAudioElement или плеер‑обёртка; поддержка play/pause/seek/next/prev, отображение оставшегося времени.
- Прогресс: сохранять `audioChapterNumber` и `position` (секунды) через `PUT /me/progress/:versionId` регулярно (например, каждые 10–20 секунд и на pause/ended). На входе — восстанавливать.
- Фоновое воспроизведение: в MVP — не обязательно; корректная пауза при уходе.
  Критерии приёмки:
- Можно слушать плейлист, переходить между главами; прогресс сохраняется и восстанавливается.
  Артефакты:
- `src/components/reader/audio/AudioPlayer.tsx`, `AudioPlaylist.tsx`, `PlayerControls.tsx`.

### 4) Summary (если доступно)

ТЗ:

- Данные: `GET /versions/:id/summary`.
- Отображение: вкладка summary с кратким содержанием, темами/анализом, если есть.
  Критерии приёмки:
- При наличии — summary отображается; при отсутствии — вкладка скрыта.
  Артефакты:
- `src/components/reader/SummaryView.tsx`.

### 5) Полка (Bookshelf)

ТЗ:

- Кнопка «На полку/Убрать» привязана к текущей версии.
- Эндпоинты: `GET /me/bookshelf` (для стартового состояния — опц.), `POST /me/bookshelf/:versionId`, `DELETE /me/bookshelf/:versionId`.
- UX: оптимистичное обновление состояния с откатом при ошибке; показывать счётчики/состояния по возможности.
  Критерии приёмки:
- Кнопка мгновенно меняет состояние; после перезагрузки состояние сохраняется.
  Артефакты:
- `src/components/reader/BookshelfToggle.tsx`.

### 6) Комментарии и лайки

ТЗ:

- Комментарии: список (пагинация), форма отправки, ветвление через `parentId?`. Таргеты: версия/глава/аудиоглава.
- Лайки: `PATCH /likes/toggle` для комментария и/или версии; отрисовать счетчик и состояние.
- Антиспам: обрабатывать 429 с friendly месседжем и блокировать сабмит на короткий период.
- Гейт: неавторизованным — CTA «Войти».
  Критерии приёмки:
- Добавление комментария/лайка работает, состояния и счётчики корректны.
  Артефакты:
- `src/components/reader/comments/CommentsThread.tsx`, `CommentForm.tsx`, `LikeButton.tsx`.

### 7) Интеграция прогресса и восстановления состояния

ТЗ:

- Абстрагировать хранение/восстановление прогресса в `src/api/endpoints/interactions.ts` и хуках `useReadingProgress(versionId)`, `useListeningProgress(versionId)`.
- Локальный fallback (LocalStorage) на случай оффлайна/ошибки сервера; синхронизировать при восстановлении сети.
  Критерии приёмки:
- При кратковременных ошибках сеть/бэк — прогресс не теряется полностью; после восстановления — синхронизация.
  Артефакты:
- `src/api/endpoints/interactions.ts`, `src/api/hooks/useProgress.ts`.

### 8) Навигация, ссылки и deeplink’и

ТЗ:

- Поддержать deeplink на главу: `?chapter=5` или `#ch-5` для текста; для аудио — `?audio=3&t=120`.
- Кнопки «Предыдущая/Следующая» учитывают границы; из оглавления — быстрый переход.
- Копируемые ссылки «Поделиться».
  Критерии приёмки:
- Прямые ссылки открывают нужную главу/позицию; share копирует корректный URL.
  Артефакты:
- Утилиты в `src/utils/reader-links.ts`.

### 9) SEO и метаданные версии

ТЗ:

- `generateMetadata()` для `/versions/[id]` вызывает `GET /seo/resolve?type=version&id=:id`.
- Canonical — `/versions/:id`; hreflang — можно опустить (один URL), но x-default оставить.
- OpenGraph/Twitter — из resolve.
  Критерии приёмки:
- Метаданные видны в исходнике/DevTools, canonical без префикса языка.
  Артефакты:
- `src/lib/seo.ts` (дополнение), реализация в роуте.

### 10) Производительность и UX

ТЗ:

- Предзагрузка соседних глав (±1) при чтении/прослушивании.
- Виртуализация длинных оглавлений (если список > 100 элементов).
- Экономия батчинга запросов (React Query), разумный retry (без повторов при 4xx).
  Критерии приёмки:
- Плавная навигация; нет заметных лагов при переключении глав.
  Артефакты:
- Внутренние оптимизации в reader компонентах и хуках.

### 11) Доступность (a11y)

ТЗ:

- Клавиатурная навигация: переключение глав/кнопок плеера.
- ARIA для кнопок/состояний плеера и списка комментариев.
- Контраст и размеры контролов на мобильных.
  Критерии приёмки:
- Базовые проверки доступности проходят (ручные, Lighthouse‑аудит).
  Артефакты:
- Атрибуты и фокус‑менеджмент в компонентах.

### 12) Ошибки и граничные случаи

ТЗ:

- 404: версия/глава/аудиоглава — отображать понятные сообщения (для `/versions/:id` — стандартный 404 страницы).
- Приватные/неопубликованные версии: либо 404 для публичных, либо доступ для staff (если backend разрешит) — отрендерить бейдж «неопубликовано».
- 429: блокировать повторные действия; таймер обратного отсчёта.
  Критерии приёмки:
- Граничные состояния обрабатываются предсказуемо и дружелюбно.
  Артефакты:
- Обработка в компонентах/хуках ошибок из M2 (`toUserMessage`).

### 13) Тестирование

ТЗ:

- E2E: открыть `/versions/:id` (text/audio), перейти по главах вперёд/назад, обновить страницу — прогресс восстановился; добавить комментарий/лайк; добавить на полку; sign‑in редирект из CTA работает.
- Unit: утилиты reader‑links, прогресс, форматирование времени; компоненты плеера (минимум рендер/коллбэки).
  Критерии приёмки:
- Ключевые e2e зелёные; unit‑тесты утилит проходят.

---

## Схема директорий (релевантное для M6)

```
app/(neutral)/versions/[id]/
  page.tsx

src/components/reader/
  TextReader.tsx
  ChapterList.tsx
  ReaderToolbar.tsx
  ProgressBar.tsx
  SummaryView.tsx
  audio/
    AudioPlayer.tsx
    AudioPlaylist.tsx
    PlayerControls.tsx
  comments/
    CommentsThread.tsx
    CommentForm.tsx
  BookshelfToggle.tsx
  LikeButton.tsx

src/api/endpoints/
  interactions.ts   # bookshelf/progress/comments/likes

src/api/hooks/
  useProgress.ts

src/utils/
  reader-links.ts
```

## Риски и примечания

- Объём глав/аудио может быть большим — нужно предусмотреть пагинацию/ленивую подгрузку и не грузить всё сразу.
- Прогресс: несогласованность клиентского времени и сервера — не критично, сохраняем часто и в резонных границах.
- Аутентификация: следить за 401/refresh по правилам M2; CTA входа с корректным callback.
- Медиа: для аудио следует учитывать CORS и возможность прерываний/буферизации; для MVP используем простые URL.

## Чек‑лист готовности M6

- [ ] `/versions/[id]` открывается, SEO корректен (canonical без языка)
- [ ] Текстовая читалка: навигация, сохранение/восстановление прогресса
- [ ] Аудиоплеер: плейлист, прогресс, управление
- [ ] Summary отображается при наличии
- [ ] Полка: добавление/удаление с оптимистичным UI
- [ ] Комментарии/лайки: список, добавление, toggle
- [ ] Deeplink’и на главу/позицию работают
- [ ] Производительность и a11y на базовом уровне
- [ ] E2E + unit‑тесты утилит зелёные
