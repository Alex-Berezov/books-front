# M3 — Админка MVP (мультиязычный контент) — подробное ТЗ

Цель: предоставить базовую админ‑панель для работы с мультиязычным контентом (en|es|fr|pt): страницы (CMS), книги, версии (текст/аудио) и главы, таксономии (категории/теги), SEO‑поля, индикаторы переводов и удобное переключение языка.

Зависимости: M0 (каркас/i18n), M1 (Auth + роли), M2 (http‑клиент/React Query/ошибки). Роли с доступом: `admin|content_manager`.

## Результат этапа

- Работает админ‑зона `/admin/:lang` с навигацией по разделам: Pages, Books, Versions, Chapters, Categories, Tags, SEO.
- Везде есть переключатель языка; переключение ведёт к переводу той же сущности (или к созданию перевода) по `groupId`.
- Формы создания/редактирования локализованных сущностей: валидация, статусы публикации, обработка ошибок, slug уникален в рамках языка.
- Списки с фильтрами/поиском, индикаторами доступных переводов и быстрыми действиями.
- Базовая SEO‑форма на уровне страницы/книги/версии с предпросмотром мета‑сниппета.

---

## Общие принципы

- URL: `/admin/[lang]/…`, где `lang ∈ en|es|fr|pt`.
- Заголовки: добавлять `X-Admin-Language` (если поддерживается) или `Accept-Language: [lang]` на все admin‑запросы.
- Модель переводов: «логическая» сущность имеет общий `groupId` и одну запись на язык. Slug и SEO — пер‑языковые, уникальность slug проверяем в рамках языка.
- Ошибки: 400/422 — inline, 401 — редирект на логин, 403 — страница 403, 404 — отсутствующий перевод (предложить создать), 409 — конфликт slug, 429 — дружелюбный месседж.
- Кэширование: React Query с ключами, включающими язык; инвалидация после создания/обновления/удаления.

---

## Задачи и ТЗ

### 1) Каркас админ‑зоны и навигация

ТЗ:

- В `app/admin/[lang]/layout.tsx` добавить AdminShell: хедер с `AdminLanguageSwitcher`, боковое меню (Pages, Books, Versions, Categories, Tags, Settings/SEO), контейнер контента.
- Навигация сохраняет текущий язык при переходах между разделами.
  Критерии приёмки:
- Боковое меню и шапка видны на всех страницах админки; язык не теряется.
  Артефакты:
- `app/admin/[lang]/layout.tsx`, `src/components/admin/AdminShell.tsx`, `src/components/admin/AdminLanguageSwitcher.tsx` (из M0 — доработка).

### 2) Резолвер переводов и индикаторы языков

ТЗ:

- Утилита `resolveTranslationRoute(entity, currentLang, targetLang)`
  - По `groupId + targetLang` пытается найти `targetId` (используя список переводов/метаданные сущности).
  - Возвращает маршрут редактирования перевода или маршрут создания перевода с `groupId` и `sourceLang`.
- Компонент `LangMatrix` для бейджей доступных переводов (en/es/fr/pt) с быстрыми действиями.
  Критерии приёмки:
- Переключатель языка на странице сущности корректно ведёт к существующему переводу или к форме создания перевода.
  Артефакты:
- `src/utils/admin-i18n.ts`, `src/components/admin/LangMatrix.tsx`.

### 3) Pages (CMS)

ТЗ:

- Список: таблица с колонками `title`, `slug`, `status`, `updatedAt`, матрица переводов; фильтры по статусу и поиск по названию/slug.
- Создание/редактирование (локализовано): поля `title`, `slug`, `type?`, `content` (пока textarea; rich‑text позже), `status: draft|published`, SEO‑поля `metaTitle`, `metaDescription`, `canonicalUrl?`.
- Валидация: обязательные поля, длины, `slug` — только латиница/дефисы; проверка уникальности (при 409 показывать конфликт). Автогенерация slug из title + ручная правка.
- Переводы: кнопка «Создать перевод» → форма с предзаполненными полями из исходного языка; слева/вверху — индикаторы языков.
- Сохранение: draft/publish; после сохранения — инвалидация списков и переводов.
  Критерии приёмки:
- Можно создать страницу на en, затем переключиться на fr и создать перевод; конфликт slug корректно обрабатывается; SEO сохраняется.
  Артефакты:
- `app/admin/[lang]/pages/list/page.tsx`, `app/admin/[lang]/pages/new/page.tsx`, `app/admin/[lang]/pages/[id]/page.tsx`, `src/components/admin/pages/PageForm.tsx`.

### 4) Books (логическая сущность + переводы)

ТЗ:

- Список: таблица с колонками `title (lang)`, `slug`, `hasText|hasAudio?` (по доступным версиям), `updatedAt`, индикаторы переводов.
- Форма (локализовано): `title`, `slug`, краткое описание `description?`, `status`, SEO‑поля.
- Отдельные действия: «Перейти к версиям» конкретной книги.
  Критерии приёмки:
- Создать книгу на en, затем переводы на 1–2 языка; статусы публикаций различаются покадрово.
  Артефакты:
- `app/admin/[lang]/books/list/page.tsx`, `app/admin/[lang]/books/new/page.tsx`, `app/admin/[lang]/books/[id]/page.tsx`, `src/components/admin/books/BookForm.tsx`.

### 5) Versions (text/audio) и главы

ТЗ:

- Список версий книги: фильтр по типу `text|audio`, язык из текущего контекста (можно переключать).
- Создание версии: поля `type` (text|audio), `language` (фикс из маршрута), `isFree?`, `status`, `sourceInfo?`.
- Главы (для text): список, добавление/редактирование, порядок (в MVP — простая нумерация, без drag‑and‑drop), поле `content` (textarea), `chapterNumber`.
- Аудиоглавы: список, добавление/редактирование, `audioUrl` (placeholder — без загрузчика), `duration?`, `chapterNumber`.
  Критерии приёмки:
- Можно создать текстовую и аудио‑версии, добавить по 1–2 главы, отредактировать и опубликовать.
  Артефакты:
- `app/admin/[lang]/books/[bookId]/versions/page.tsx`, `app/admin/[lang]/versions/[id]/page.tsx`, `src/components/admin/versions/VersionForm.tsx`, `src/components/admin/chapters/ChapterForm.tsx`, `src/components/admin/chapters/AudioChapterForm.tsx`.

### 6) Таксономии: категории и теги

ТЗ:

- Списки: таблицы с колонками `name`, `slug`, `count?`, индикаторы переводов; поиск/фильтр.
- Формы (локализовано): `name`, `slug`, `description?`, `status`.
- Привязка к книгам/версиям: мультиселект (в версии/книге выбрать категории/теги; либо из списка категорий — привязки к книгам).
  Критерии приёмки:
- Создать по 2–3 категории/тега в en; на другой язык — переводы; привязать к 1–2 книгам/версиям.
  Артефакты:
- `app/admin/[lang]/categories/...`, `app/admin/[lang]/tags/...`, формы `CategoryForm.tsx`, `TagForm.tsx`.

### 7) SEO‑поля и предпросмотр

ТЗ:

- В формах сущностей добавить секцию SEO: `metaTitle`, `metaDescription`, `canonicalUrl?`, `robots?` (опц.).
- Предпросмотр: компонент `SeoPreview` показывает, как это будет выглядеть в результатах поиска (title/description/URL). Подсказки по длине.
- Соблюдать правила canonical из docs (version — без префикса :lang, book/page — с префиксом :lang).
  Критерии приёмки:
- SEO‑поля валидируются, предпросмотр обновляется на лету.
  Артефакты:
- `src/components/admin/seo/SeoFields.tsx`, `src/components/admin/seo/SeoPreview.tsx`.

### 8) Поиск, фильтры, пагинация

ТЗ:

- Реализовать форму фильтра и строку поиска в списках; поддержать пагинацию (по возможностям API).
- Состояние фильтров хранить в query‑параметрах URL; при переключении языка переносить фильтры.
  Критерии приёмки:
- Фильтрация и поиск работают, URL отражает состояние, переключение языка сохраняет фильтры.
  Артефакты:
- Хелперы работы с query: `src/utils/url-state.ts`.

### 9) Сохранение черновиков и защита от потери данных

ТЗ:

- Перед уходом со страницы редактирования при несохранённых изменениях показывать confirm‑диалог.
- (Опц.) Автосохранение черновика раз в N секунд (в MVP можно отложить).
  Критерии приёмки:
- Переход к другому роуту без сохранения вызывает подтверждение.
  Артефакты:
- Хук `useUnsavedChangesGuard`.

### 10) Инвалидирование и кеш React Query

ТЗ:

- После create/update/delete — инвалидировать соответствующие ключи: списки, детали, переводы.
- Обновлять локальные кэши (optimistic updates) при неопасных изменениях (например, смена статуса) — опционально.
  Критерии приёмки:
- Видно мгновенное обновление UI после сохранения; при перезагрузке данные актуальны.
  Артефакты:
- Инвалидаторы в `src/api/mutations/*` или внутри форм.

### 11) Права доступа и 403 UX

ТЗ:

- При отсутствии нужных ролей — страница 403 в админке с понятным сообщением и CTA «Вернуться/Выйти».
- Скрывать кнопки действий, требующие прав.
  Критерии приёмки:
- Пользователь без ролей не может попасть в разделы и видит 403.
  Артефакты:
- `app/admin/[lang]/forbidden/page.tsx` (если ещё нет), условный рендер контролов.

### 12) Логи/аудит (опционально)

ТЗ:

- Протоколировать (консоль/тонкие тосты) ключевые админ‑действия: создание, публикация, удаление.
  Критерии приёмки:
- При ключевых операциях есть понятная обратная связь.

### 13) Тестирование

ТЗ:

- Unit: утилиты `resolveTranslationRoute`, генерация slug, валидация SEO длины.
- E2E: сценарий создания Page на en → переключение на fr → создание перевода; конфликт slug (409) — корректное сообщение; создание версии и главы.
- Ручные: переключатель языка в админке переносит фильтры/состояние, защита от потери данных работает.
  Критерии приёмки:
- Ключевые e2e проходят; unit‑тесты утилит зелёные.

---

## Схема директорий (релевантное для M3)

app/admin/[lang]/

- layout.tsx
- pages/
  - list/page.tsx
  - new/page.tsx
  - [id]/page.tsx
- books/
  - list/page.tsx
  - new/page.tsx
  - [id]/page.tsx
- books/[bookId]/versions/page.tsx
- versions/[id]/page.tsx
- categories/
  - list/page.tsx
  - new/page.tsx
  - [id]/page.tsx
- tags/
  - list/page.tsx
  - new/page.tsx
  - [id]/page.tsx
- forbidden/page.tsx (опц.)

src/components/admin/

- AdminShell.tsx, AdminLanguageSwitcher.tsx, LangMatrix.tsx
- pages/PageForm.tsx
- books/BookForm.tsx
- versions/VersionForm.tsx
- chapters/ChapterForm.tsx, chapters/AudioChapterForm.tsx
- seo/SeoFields.tsx, seo/SeoPreview.tsx

src/utils/

- admin-i18n.ts, url-state.ts, slug.ts, validation.ts

src/api/

- endpoints/admin/\* (TBD под бекенд‑контракты)
- hooks/admin/\* (usePages, useBooks, useVersions, useChapters, useCategories, useTags)
- mutations/admin/\* (create/update/delete для сущностей)

---

## Артефакты этапа

- Разделы админки с маршрутами и формами в соответствии с вышеописанной схемой.
- Компоненты переключения языка, матрицы переводов, SEO‑полей и предпросмотра.
- Утилиты резолва переводов и работы с URL/slug/валидацией.
- Хуки/эндпоинты/мутации на базе клиента из M2 (пути API синхронизировать с backend).

## Риски и примечания

- Админские API для CRUD не зафиксированы в текущих docs — требуется синхронизация с backend (пути, пейлоады, статусы). На FE завернуть в слой `endpoints/admin/*`, чтобы менять пути централизованно.
- Валидация slug: может потребоваться отдельный эндпоинт проверки уникальности; если его нет, обрабатывать 409 как сигнал конфликта.
- Богатый редактор контента (rich‑text/uploads) — вне MVP; начать с textarea и статического контента.
- Массовые связи (привязка категорий/тегов) — убедиться в наличии пагинации/поиска на бекенде.
- Автосохранение черновиков — опционально, добавлять после базовой стабильности форм.

## Чек‑лист готовности M3

- [ ] Каркас админки и навигация
- [ ] Переключение языка и резолвер переводов
- [ ] Pages: список, создание/редактирование, SEO, переводы
- [ ] Books: список, создание/редактирование, переводы
- [ ] Versions + главы: создание/редактирование, списки
- [ ] Categories/Tags: списки и формы, привязки
- [ ] Индикаторы переводов и UX‑мелочи (slug, подтверждения, ошибки)
- [ ] Инвалидация кэша и базовые тесты
